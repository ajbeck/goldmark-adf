# Implementation Plan: go-markdown-adf

## Overview

Build a goldmark renderer that outputs Atlassian Document Format (ADF) JSON instead of HTML.

## Key Decisions Made

1. **JSON Strategy**: Struct-based with `encoding/json/v2` (experimental, requires `GOEXPERIMENT=jsonv2`)
2. **Starting Point**: Core blocks first, with validation testing infrastructure
3. **Image Handling**: Convert to links (documented alternatives in `docs/future-improvements/`)
4. **GFM Support**: Include tables, strikethrough, task lists

## Schema Migration: Draft-04 to Draft-07

The ADF JSON schema uses **draft-04** (`"$schema": "http://json-schema.org/draft-04/schema#"`), but `github.com/google/jsonschema-go` only supports draft-07 and draft 2020-12.

**Solution**: Migrate the ADF schema from draft-04 to draft-07 format.

### Draft-04 to Draft-07 Migration Changes

| Draft-04 | Draft-07 | Notes |
|----------|----------|-------|
| `"$schema": "http://json-schema.org/draft-04/schema#"` | `"$schema": "http://json-schema.org/draft-07/schema#"` | Update schema URI |
| `"definitions"` | `"definitions"` | Unchanged (deprecated in 2019-09, replaced by `$defs`) |
| `"exclusiveMinimum": true` + `"minimum": X` | `"exclusiveMinimum": X` | Boolean → number |
| `"exclusiveMaximum": true` + `"maximum": X` | `"exclusiveMaximum": X` | Boolean → number |
| `"id"` | `"$id"` | Keyword renamed |

### Migration Script

Create `scripts/migrate-schema.go` to automate:
1. Download original draft-04 schema
2. Transform to draft-07 format
3. Save as `adfschema/adf-schema.json`
4. Validate the migrated schema parses correctly

### Key Transformations Needed

1. **Schema declaration**: Change `$schema` URI
2. **Exclusive bounds**: Draft-04 uses boolean `exclusiveMinimum/Maximum` with separate `minimum/maximum`. Draft-07 uses numeric values directly.
3. **ID keyword**: `id` → `$id` (if present)
4. **Verify**: The ADF schema likely doesn't use the changed keywords heavily, so migration should be straightforward.

## Package Structure

```
github.com/ajbeck/goldmark-adf/
├── doc.go                    # Package documentation
├── adf.go                    # Main renderer implementation
├── nodes.go                  # ADF node type definitions
├── renderer.go               # NodeRenderer implementation
├── options.go                # Configuration options
├── scripts/                  # Build/dev scripts
│   └── migrate-schema.go     # Draft-04 → Draft-07 migration
├── adfschema/                # Validation package
│   ├── schema.go             # Schema loading and validation
│   ├── schema_test.go        # Validation tests
│   └── adf-schema.json       # Migrated ADF schema (draft-07)
├── docs/                     # Documentation (already created)
│   ├── overview.md
│   ├── node-mapping.md
│   ├── html-renderer-patterns.md
│   └── future-improvements/
│       └── image-handling.md
└── testdata/                 # Test fixtures
    ├── basic/
    │   ├── paragraph.md
    │   ├── paragraph.json
    │   └── ...
    └── gfm/
        ├── table.md
        ├── table.json
        └── ...
```

## Implementation Phases

### Phase 1: Foundation & Validation Infrastructure

**Files to create:**

1. `scripts/migrate-schema.go` - Schema migration tool
   - Download draft-04 schema from Atlassian
   - Transform to draft-07 format
   - Output migrated schema

2. `adfschema/adf-schema.json` - Migrated schema (draft-07)
   - Generated by migration script
   - Embedded using `//go:embed`

3. `adfschema/schema.go` - Validation package
   ```go
   package adfschema

   import (
       _ "embed"
       "encoding/json"

       "github.com/google/jsonschema-go/jsonschema"
   )

   //go:embed adf-schema.json
   var schemaJSON []byte

   var schema *jsonschema.Resolved

   func init() {
       var s jsonschema.Schema
       if err := json.Unmarshal(schemaJSON, &s); err != nil {
           panic(err)
       }
       var err error
       schema, err = s.Resolve(nil)
       if err != nil {
           panic(err)
       }
   }

   // Validate validates ADF JSON against the schema.
   func Validate(data []byte) error {
       var instance any
       if err := json.Unmarshal(data, &instance); err != nil {
           return err
       }
       return schema.Validate(instance)
   }
   ```

4. `nodes.go` - ADF node type definitions
   ```go
   //go:build goexperiment.jsonv2

   package adf

   type Document struct {
       Version int    `json:"version"`
       Type    string `json:"type"`
       Content []Node `json:"content"`
   }

   type Node struct {
       Type    string         `json:"type"`
       Content []Node         `json:"content,omitempty"`
       Attrs   map[string]any `json:"attrs,omitempty"`
       Marks   []Mark         `json:"marks,omitempty"`
       Text    string         `json:"text,omitempty"`
   }

   type Mark struct {
       Type  string         `json:"type"`
       Attrs map[string]any `json:"attrs,omitempty"`
   }
   ```

### Phase 2: Core Renderer

**Files to create:**

1. `renderer.go` - Main renderer implementation
   - Implement `renderer.NodeRenderer` interface
   - Register handlers for all AST node kinds
   - Use struct-based node building with stack

2. `adf.go` - Public API
   ```go
   func NewRenderer(opts ...Option) renderer.NodeRenderer
   func New(opts ...Option) goldmark.Markdown
   ```

3. `options.go` - Configuration options
   - `WithImageHandler()`
   - `WithTableLayout()`

### Phase 3: Block Node Handlers

Implement in order:
1. Document → doc wrapper
2. Paragraph → paragraph
3. Heading → heading (with level attr)
4. Blockquote → blockquote
5. ThematicBreak → rule
6. List (ordered/unordered) → orderedList/bulletList
7. ListItem → listItem
8. CodeBlock/FencedCodeBlock → codeBlock

### Phase 4: Inline Node Handlers

1. Text → text node
2. Emphasis → em/strong marks
3. CodeSpan → code mark
4. Link → link mark
5. AutoLink → link mark
6. Image → text with link mark (current implementation)
7. HardBreak → hardBreak

### Phase 5: GFM Extension Support

1. Table → table structure
2. TableRow → tableRow
3. TableHeader → tableHeader cells
4. TableCell → tableCell cells
5. Strikethrough → strike mark
6. TaskList → taskList (if supported by goldmark extension)

### Phase 6: Testing

**Test structure:**
```
testdata/
├── basic/
│   ├── paragraph.md          # "Hello world"
│   ├── paragraph.json        # Expected ADF
│   ├── heading.md            # "# Title"
│   ├── heading.json
│   └── ...
└── gfm/
    ├── table.md
    ├── table.json
    └── ...
```

**Test approach:**
1. Parse markdown with goldmark
2. Render to ADF JSON
3. Validate against ADF schema
4. Compare with expected JSON

## Build & Test Commands

```bash
# Build with json/v2 experimental support
GOEXPERIMENT=jsonv2 go build ./...

# Run tests
GOEXPERIMENT=jsonv2 go test ./...

# Run specific validation tests
GOEXPERIMENT=jsonv2 go test ./adfschema -v
```

## Critical Files

- `/Users/aj/go/pkg/mod/github.com/yuin/goldmark@v1.7.16/renderer/html/html.go` - Reference implementation
- `https://unpkg.com/@atlaskit/adf-schema@51.5.6/dist/json-schema/v1/full.json` - ADF schema

## Verification

1. Create simple test markdown files
2. Run renderer and capture output
3. Validate output against ADF schema
4. Visual verification in Jira/Confluence (if access available)
5. Unit tests for each node type

## Dependencies

- `github.com/yuin/goldmark` - Markdown parser
- `github.com/google/jsonschema-go` - JSON Schema validation (using migrated draft-07 schema)
